{% extends "base.html" %}
{% from "macros/wizard_steps.html" import step_bar %}

{% block title %}libvirt/KVM Configuration{% endblock %}

{% block content %}
{{ step_bar(current_step='libvirt') }}

<div class="card">
    <h2>libvirt/KVM Configuration</h2>
    <p>Configure the libvirt hypervisor for VM provisioning.</p>

    {% if not detected.kvm_available %}
    <div class="alert alert-warning">
        KVM hardware acceleration not detected (/dev/kvm missing).
        VMs will run in QEMU emulation mode, which is significantly slower.
    </div>
    {% endif %}

    {% if not detected.libvirtd_running %}
    <div class="alert alert-warning">
        libvirtd service is not running. It will be started during finalization.
    </div>
    {% endif %}

    <form method="POST">
        <div class="form-section">
            <h3>Storage</h3>
            <div class="form-group">
                <label for="storage_pool">Storage pool name</label>
                <input type="text" id="storage_pool" name="storage_pool"
                       value="blockhost" required>
            </div>
            <div class="form-group">
                <label for="storage_path">Storage path</label>
                <input type="text" id="storage_path" name="storage_path"
                       value="/var/lib/blockhost/vms" required>
            </div>
        </div>

        <div class="form-section">
            <h3>Network</h3>
            <p class="form-help">
                VMs use NAT via libvirt's default network.
                IPv6 is routed end-to-end via WireGuard tunnel.
            </p>
            {% if detected.wan_interfaces|length > 1 %}
            <div class="form-group">
                <label for="wan_interface">WAN interface</label>
                <select id="wan_interface" name="wan_interface">
                    {% for iface in detected.wan_interfaces %}
                    <option value="{{ iface }}">{{ iface }}</option>
                    {% endfor %}
                </select>
            </div>
            {% elif detected.wan_interfaces|length == 1 %}
            <input type="hidden" name="wan_interface" value="{{ detected.wan_interfaces[0] }}">
            <div class="form-group">
                <label>WAN interface</label>
                <span class="form-static">{{ detected.wan_interfaces[0] }}</span>
            </div>
            {% else %}
            <div class="alert alert-warning">
                No WAN interface detected (no default route found).
            </div>
            {% endif %}
        </div>

        <div class="form-section">
            <h3>Lifecycle</h3>
            <div class="form-group">
                <label for="gc_grace_days">Grace period before VM destruction (days)</label>
                <input type="number" id="gc_grace_days" name="gc_grace_days"
                       value="7" min="1" max="90">
            </div>
        </div>

        <div class="flex justify-between" style="margin-top: 2rem;">
            <a href="{{ url_for('wizard_blockchain') }}" class="btn btn-secondary">Back</a>
            <button type="submit" class="btn btn-primary">Continue</button>
        </div>
    </form>
</div>
{% endblock %}
